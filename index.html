<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 æ™ºèƒ½æ“ç›¤ç³»çµ± (v4.0 3Dé›™æ ¸ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-dark: #0f172a; --glass-bg: rgba(30, 41, 59, 0.7); --glass-border: rgba(255, 255, 255, 0.08);
            --primary: #6366f1; --secondary: #ec4899; --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --text-main: #f8fafc; --text-muted: #94a3b8; --card-radius: 16px;
        }
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: var(--bg-dark);
            background-image: radial-gradient(at 0% 0%, rgba(99,102,241,0.15), transparent 50%), radial-gradient(at 100% 0%, rgba(236,72,153,0.15), transparent 50%);
            color: var(--text-main); margin: 0; padding: 20px; box-sizing: border-box;
        }
        .container { max-width: 1200px; margin: 0 auto; display: grid; gap: 24px; }
        
        header { padding: 24px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--card-radius); backdrop-filter: blur(12px); text-align: center; position: relative; overflow: hidden; }
        header::after { content:''; position: absolute; bottom:0; left:0; width:100%; height:2px; background: linear-gradient(90deg, var(--primary), var(--secondary)); }
        h1 { margin: 0; background: linear-gradient(135deg, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 24px; font-weight: 700; }
        .subtitle { font-size: 14px; color: var(--primary); margin-top: 5px; font-weight: 500; letter-spacing: 1px; }

        .status-container { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 8px; position: relative; overflow: hidden; margin-top: 10px; }
        .status-bar-content { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; }
        .status-progress-bar { height: 3px; width: 100%; background: rgba(255,255,255,0.05); position: absolute; bottom: 0; }
        .status-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.3s; }
        .indeterminate { width: 30%; animation: loading-bar 1.5s infinite linear; }
        @keyframes loading-bar { 0% { left: -30%; } 100% { left: 100%; } }

        .dashboard { display: grid; grid-template-columns: 1fr; gap: 24px; }
        @media(min-width: 992px) { .dashboard { grid-template-columns: 1fr 1fr; } }
        
        .card { background: var(--glass-bg); padding: 24px; border-radius: var(--card-radius); border: 1px solid var(--glass-border); backdrop-filter: blur(16px); position: relative; display: flex; flex-direction: column; }
        .card h2 { margin: 0 0 20px; font-size: 18px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .card-tag { font-size: 11px; padding: 4px 10px; border-radius: 20px; background: linear-gradient(90deg, var(--primary), #818cf8); color: white; }

        .control-row { display: flex; gap: 12px; margin-bottom: 15px; }
        .unit-input-group { display: flex; align-items: center; gap: 10px; background: #1e293b; padding: 8px 15px; border-radius: 8px; border: 1px solid #475569; flex: 1; }
        .unit-input { width: 60px; border: none; text-align: center; font-weight: 700; color: var(--warning); background: transparent; outline: none; font-size: 16px; }
        .btn-action { border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: white; transition: transform 0.2s; background: linear-gradient(135deg, var(--primary), #4f46e5); padding: 10px 20px; }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .btn-reset { background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 5px 10px; font-size: 12px; border-radius: 6px; cursor: pointer; }
        .btn-reset:hover { background: #ef4444; color: white; }

        .strategy-box { background: rgba(15,23,42,0.4); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; margin-top: auto; }
        .strategy-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .stat-item { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; text-align: center; }
        .stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 5px; }
        .stat-value { font-size: 18px; font-weight: 700; color: white; }
        .val-win { color: var(--success); } .val-loss { color: var(--danger); }
        
        .signal-display { text-align: center; padding: 20px 0; }
        .sig-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
        .badge-pursuit { background: rgba(239,68,68,0.2); color: #fca5a5; border: 1px solid #ef4444; }
        .badge-wait { background: rgba(148,163,184,0.2); color: #cbd5e1; border: 1px solid #64748b; }
        .badge-lock { background: rgba(245,158,11,0.2); color: #fcd34d; border: 1px solid #f59e0b; }

        .sig-main { font-size: 32px; font-weight: 800; margin: 10px 0; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .sig-desc { font-size: 14px; color: var(--text-muted); background: rgba(0,0,0,0.3); display: inline-block; padding: 5px 15px; border-radius: 8px; line-height: 1.5; }
        
        .signal-grid { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .priority-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; text-align: left; font-size: 14px; color: #e2e8f0; border-left: 3px solid transparent; }
        .priority-card.active { background: rgba(99,102,241,0.1); border-left: 3px solid var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .p-rank { font-weight: bold; color: var(--warning); margin-bottom: 5px; display: block; font-size: 16px; }

        .full-history-card { grid-column: 1 / -1; }
        .history-table-container { overflow-x: auto; border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; max-height: 500px; }
        .full-history-table { width: 100%; border-collapse: collapse; white-space: nowrap; font-size: 14px; text-align: center; }
        .full-history-table th { background: rgba(30,41,59,0.9); padding: 14px; color: var(--text-muted); position: sticky; top: 0; z-index: 2; }
        .full-history-table td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.03); color: #e2e8f0; }
        .full-history-table tr:hover { background: rgba(255,255,255,0.02); }
        
        .num-ball { display: inline-block; width: 24px; height: 24px; line-height: 24px; border-radius: 50%; font-size: 12px; margin: 0 2px; color: #94a3b8; background: #1e293b; font-weight: bold; }
        .res-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 800; }
        .badge-win { background: rgba(16,185,129,0.15); color: #34d399; } .badge-loss { background: rgba(239,68,68,0.15); color: #f87171; }

        .chart-container { position: relative; height: 350px; width: 100%; margin-top: 10px; }
        #manualInputSection { display: none; margin-top: 10px; padding: 15px; background: rgba(239,68,68,0.1); border: 1px solid #ef4444; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>539 æ™ºèƒ½æ“ç›¤ç³»çµ±</h1>
        <div class="subtitle">3D å‹•æ…‹å‡å€¼å›æ­¸å¼•æ“ (é›™æ ¸ä¸¦è¡Œ x 1-3-8 è¿½æ“Š)</div>
    </header>

    <div class="status-container">
        <div class="status-bar-content">
            <div>
                <div id="statusText" style="font-weight:600;">â³ ç³»çµ±å•Ÿå‹•ä¸­...</div>
                <div id="dataInfoBlock" style="font-size:12px; color:var(--text-muted);"></div>
            </div>
            <button class="btn-reset" onclick="App.resetData()">ğŸ”„ æ¸…é™¤å¿«å–é‡æŠ“</button>
        </div>
        <div class="status-progress-bar"><div class="status-progress-fill" id="statusProgressBar"></div></div>
    </div>

    <div id="manualInputSection">
        <p style="color:#fca5a5; font-weight:bold; margin-bottom:10px;">âš ï¸ ç„¡æ³•æŠ“å–æœ€æ–°è³‡æ–™ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ï¼š</p>
        <div style="display:flex; justify-content:center; gap:5px; margin-bottom:10px;">
            <input type="number" id="m1" style="width:40px; padding:5px;"><input type="number" id="m2" style="width:40px; padding:5px;">
            <input type="number" id="m3" style="width:40px; padding:5px;"><input type="number" id="m4" style="width:40px; padding:5px;">
            <input type="number" id="m5" style="width:40px; padding:5px;">
        </div>
        <button class="btn-action" onclick="App.manualInput()">ç¢ºèªè¼¸å…¥</button>
    </div>

    <div class="dashboard">
        <div class="card">
            <h2><span>ğŸ’° ç­–ç•¥å›æ¸¬é¢æ¿</span><span class="card-tag">Verified v4.0</span></h2>
            
            <div class="control-row">
                <div class="unit-input-group">
                    <span style="font-size:13px; color:#cbd5e1;">å–®å€æ³¨ç¢¼æˆæœ¬ ($):</span>
                    <input type="number" id="baseUnit" class="unit-input" value="1062" readonly>
                </div>
                <button class="btn-action" onclick="App.runAnalysis()">âš¡ åŸ·è¡Œå›æ¸¬</button>
            </div>

            <div class="strategy-box">
                <div class="strategy-grid">
                    <div class="stat-item"><div class="stat-label">ç´¯ç©æ·¨åˆ© (Net)</div><div class="stat-value" id="st-profit">--</div></div>
                    <div class="stat-item"><div class="stat-label">ç¸½é€²å ´æ¬¡æ•¸</div><div class="stat-value" id="st-pursuits">--</div></div>
                    <div class="stat-item"><div class="stat-label">ç³»çµ±å‹ç‡</div><div class="stat-value" id="st-winrate">--%</div></div>
                    <div class="stat-item"><div class="stat-label">æœ€å¤§å›æ’¤ (MDD)</div><div class="stat-value val-loss" id="st-mdd">--</div></div>
                </div>
                <div style="font-size:12px; color:var(--text-muted); margin-top:15px; text-align:center; line-height:1.5;">
                    æ ¸å¿ƒæˆ°ç•¥ï¼š3D å‹•æ…‹è©•åˆ† (æ»¿50åˆ†é€²å ´) + é›™æ ¸ä¸¦è¡Œ (Max: 2)<br>
                    è³‡é‡‘æ§ç®¡ï¼š1å€ â” 3å€ â” 8å€ (å–®æ¬¡åœææº–å‚™é‡‘ 12,744)
                </div>
            </div>
        </div>

        <div class="card">
            <h2><span>ğŸ”® ä¸‹ä¸€æœŸæ“ç›¤æŒ‡ä»¤</span><span class="card-tag" style="background:#ec4899;">Action</span></h2>
            
            <div style="text-align:center; margin-bottom:15px;">
                <div style="font-size:12px; color:var(--text-muted);">åƒè€ƒæ•¸æ“šæ—¥: <span id="last-bet-date" style="color:var(--primary);">--/--</span></div>
                <div id="nextDrawDate" style="font-size:20px; font-weight:800; color:white;">--/--</div>
            </div>

            <div class="signal-display">
                <div id="pred-badge" class="sig-badge badge-wait">ç­‰å¾…è¨ˆç®—</div>
                <div id="pred-strategy" class="sig-main">--</div>
                <div id="pred-desc" class="sig-desc">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
            </div>

            <div class="signal-grid" id="signalContainer">
                </div>
        </div>
        
        <div class="card full-history-card">
            <h2><span>ğŸ“ˆ è³‡é‡‘æ¬Šç›Šæ›²ç·š (Equity Curve)</span></h2>
            <div class="chart-container"><canvas id="equityChart"></canvas></div>
        </div>

        <div class="card full-history-card">
            <h2><span>ğŸ“œ è©³ç´°äº¤æ˜“ç´€éŒ„ (åƒ…é¡¯ç¤ºæœ‰äº¤æ˜“ä¹‹æœŸæ•¸)</span></h2>
            <div class="history-table-container">
                <table class="full-history-table">
                    <thead><tr><th>æ—¥æœŸ</th><th>é–‹çè™Ÿç¢¼</th><th>è¿½æ“Šè¨Šè™Ÿ</th><th>åŸ·è¡Œéšæ®µ/å€æ•¸</th><th>æç›Š</th><th>çµç®—</th></tr></thead>
                    <tbody id="fullHistoryBody"></tbody>
                </table>
            </div>
            <div style="display:flex; justify-content:center; gap:15px; margin-top:20px;">
                <button onclick="UI.changePage(-1)" style="padding:5px 15px; cursor:pointer; background:#334155; border:none; color:white; border-radius:4px;">â—€ ä¸Šä¸€é </button>
                <span id="pageInfo" style="line-height:30px; font-size:14px;">1 / 1</span>
                <button onclick="UI.changePage(1)" style="padding:5px 15px; cursor:pointer; background:#334155; border:none; color:white; border-radius:4px;">ä¸‹ä¸€é  â–¶</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. Constants & Config ---
    const $ = id => document.getElementById(id);
    const CONFIG = {
        DRIVE_ID: '1K2CNRIE97NRfJrzKiG8Adcz_tFeYHPlm',
        STORAGE_KEY: 'lotto539_v4_3d_engine',
        BASE_URL: "https://www.lotto-8.com/listlto539.asp",
        COST: 1062, PRIZE_3: 1710, PRIZE_4: 2280,
        MULTIPLIERS: [1, 3, 8],
        MAX_CONCURRENT: 2,
        THRESHOLD: 50,
        HEADS: { 
            0: new Set([1,2,3,4,5,6,7,8,9]),
            1: new Set([11,12,13,14,15,16,17,18,19]),
            2: new Set([21,22,23,24,25,26,27,28,29]),
            3: new Set([31,32,33,34,35,36,37,38,39])
        },
        COMBS: [[0,1], [0,2], [0,3], [1,2], [2,3]] // 1/3 is excluded
    };

    let AppState = { fullData: [], history: [], page: 1, chart: null, latestPrediction: null };

    // --- 2. Data Module (å«å¤šç¯€é» CORS å‚™æ´æ©Ÿåˆ¶) ---
    const Data = {
        async init() {
            try { 
                const cached = localStorage.getItem(CONFIG.STORAGE_KEY);
                AppState.fullData = cached ? JSON.parse(cached) : [];
            } catch(e){ AppState.fullData = []; }
            if(AppState.fullData.length === 0) await this.fetchCloud();
            this.forceFetch();
        },
        async fetchCloud() {
            UI.status("â˜ï¸ åŒæ­¥é›²ç«¯æ•¸æ“š...", "loading");
            try {
                const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(`https://drive.google.com/uc?export=download&id=${CONFIG.DRIVE_ID}`)}`);
                const data = await res.json();
                this.merge(data);
            } catch(e) {}
        },
        async forceFetch() {
            UI.status("ğŸ“¡ æŠ“å–æœ€æ–°é–‹ç (åˆ‡æ›ç¯€é»ä¸­)...", "loading");
            let newData = [];
            
            // ğŸ”§ æä¾› 3 ç¨®ä¸åŒçš„ CORS ä»£ç†ä¼ºæœå™¨å‚™æ´
            const proxies = [
                u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
                u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
                u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`
            ];

            // æŠ“å–å‰ 2 é æœ€æ–°è³‡æ–™
            for(let i=1; i<=2; i++) {
                let url = `${CONFIG.BASE_URL}?indexpage=${i}&orderby=new`;
                let html = null;
                
                // ğŸ”„ ä»£ç†ç¯€é»è¼ªè©¢
                for(let proxy of proxies) {
                    try {
                        let fetchUrl = proxy(url);
                        let res = await fetch(fetchUrl, { cache: "no-store" }); 
                        
                        if (!res.ok) continue; 
                        
                        let txt = await res.text();
                        // ç¢ºä¿æŠ“å›ä¾†çš„æ˜¯æ­£ç¢ºçš„ HTML è¡¨æ ¼å…§å®¹
                        if(txt.includes("<table") && txt.length > 500) { 
                            html = txt; 
                            break; 
                        }
                    } catch(e) {
                        console.log("ä»£ç†ç¯€é»å¤±æ•ˆï¼Œè‡ªå‹•åˆ‡æ›ä¸‹ä¸€å€‹å‚™æ´...", e);
                    }
                }
                
                if(html) {
                    let parsed = this.parseHtml(html);
                    if(parsed.length) newData.push(...parsed);
                }
            }

            if(newData.length > 0) {
                this.merge(newData);
                UI.status(`âœ… æ›´æ–°å®Œæˆ`, "success");
            } else if (AppState.fullData.length > 0) {
                UI.status("âœ… è³‡æ–™å·²æ˜¯æœ€æ–° (ç·šä¸Šç¯€é»å£…å¡ï¼Œæ²¿ç”¨æœ¬æ©Ÿå¿«å–)", "success");
            } else {
                UI.status("âš ï¸ ä»£ç†ç¯€é»å…¨æ•¸ç•°å¸¸ï¼Œè«‹æ‰‹å‹•è¼¸å…¥", "error");
                $('manualInputSection').style.display = 'block';
            }
            App.runEngine();
        },
        merge(newData) {
            const map = new Map();
            [...newData, ...AppState.fullData].forEach(d => map.set(d.date, d));
            AppState.fullData = Array.from(map.values()).sort((a,b) => b.date.localeCompare(a.date));
            localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(AppState.fullData));
            UI.updateInfo();
        },
        parseHtml(html) {
            const doc = new DOMParser().parseFromString(html, "text/html");
            let res = [];
            doc.querySelectorAll("tr").forEach(row => {
                const txt = row.innerText.trim();
                const dMatch = txt.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
                if(dMatch) {
                    let allNums = txt.match(/\d{2}/g) || [];
                    let valid = [];
                    for(let i=allNums.length-1; i>=0; i--) {
                        let n = parseInt(allNums[i]);
                        if(n>=1 && n<=39 && !valid.includes(n)) valid.unshift(n);
                        if(valid.length===5) break;
                    }
                    if(valid.length===5) res.push({ 
                        date: `${dMatch[1]}/${dMatch[2].padStart(2,'0')}/${dMatch[3].padStart(2,'0')}`, 
                        numbers: valid 
                    });
                }
            });
            return res;
        }
    };

    // --- 3. The 3D Dual-Core Engine (1-3-8) ---
    const Engine = {
        isWin(numsArr, comb) {
            let c1=0, c2=0;
            numsArr.forEach(n => {
                if(CONFIG.HEADS[comb[0]].has(n)) c1++;
                else if(CONFIG.HEADS[comb[1]].has(n)) c2++;
            });
            let c3 = 5 - c1 - c2;
            if(c1>0 && c2>0 && c3>0) {
                let counts = [c1, c2, c3].sort((a,b)=>a-b);
                if(counts[0]===1 && counts[1]===1 && counts[2]===3) return {won:true, rev: CONFIG.PRIZE_3};
                if(counts[0]===1 && counts[1]===2 && counts[2]===2) return {won:true, rev: CONFIG.PRIZE_4};
            }
            return {won:false, rev:0};
        },
        getBrokenHeads(numsArr) {
            let broken = [];
            for(let h=0; h<4; h++) {
                let hasHead = numsArr.some(n => CONFIG.HEADS[h].has(n));
                if(!hasHead) broken.push(h);
            }
            return broken;
        },
        calcScore(history, currentIndex, comb, prevBroken) {
            // Drought
            let dr = 0;
            let idx = currentIndex;
            while(idx >= 0 && !this.isWin(history[idx].numbers, comb).won) {
                dr++; idx--;
            }
            
            // Base
            let base = 0;
            if(dr===3) base=10; else if(dr===4) base=30; else if(dr===5) base=40; else if(dr>=6) base=50;
            
            // Bonus
            let bonus = 0;
            if(prevBroken.includes(0)) {
                if(comb[0]===1 && comb[1]===2) bonus=Math.max(bonus,40);
                if(comb[0]===0 && comb[1]===3) bonus=Math.max(bonus,20);
            }
            if(prevBroken.includes(1) && comb[0]===0 && comb[1]===2) bonus=Math.max(bonus,40);
            if(prevBroken.includes(2)) {
                if(comb[0]===2 && comb[1]===3) bonus=Math.max(bonus,40);
                if((comb[0]===1&&comb[1]===2) || (comb[0]===0&&comb[1]===3) || (comb[0]===0&&comb[1]===1)) bonus=Math.max(bonus,20);
            }
            if(prevBroken.includes(3) && comb[0]===0 && comb[1]===1) bonus=Math.max(bonus,20);
            
            // Trend (Lookback 20)
            let missCount = 0;
            let startIdx = Math.max(0, currentIndex - 19);
            for(let j=startIdx; j<=currentIndex; j++) {
                if(!this.isWin(history[j].numbers, comb).won) missCount++;
            }
            
            let trend = 0;
            let trendDesc = `âšª æ­£å¸¸ (${missCount}æ¬¡)`;
            if(missCount>=12) { trend=10; trendDesc=`ğŸ”´ è¶…è³£ (+10åˆ†, æ§“${missCount}æ¬¡)`; }
            else if(missCount<=7) { trend=-10; trendDesc=`ğŸ”µ è¶…è²· (-10åˆ†, æ§“${missCount}æ¬¡)`; }
            
            return { total: base+bonus+trend, base, bonus, trend, trendDesc, dr };
        },
        run() {
            let simData = [...AppState.fullData].reverse(); 
            if(simData.length < 20) return null;

            let active_pursuits = []; 
            let historyLog = [];
            let daily_pnl = new Array(simData.length).fill(0);
            
            let stats = { pursuits:0, wins:0, losses:0 };

            for(let i=20; i<simData.length; i++) {
                let dailyTrades = [];
                let next_active = [];
                
                // 1. Resolve active pursuits today
                for(let p of active_pursuits) {
                    let cStr = `${p.comb[0]}/${p.comb[1]}`;
                    let mult = CONFIG.MULTIPLIERS[p.step];
                    let cost = CONFIG.COST * mult;
                    
                    daily_pnl[i] -= cost;
                    let res = this.isWin(simData[i].numbers, p.comb);
                    
                    let tradeLog = {
                        combStr: cStr, step: p.step, mult,
                        cost, rev:0, net: -cost, won: false
                    };

                    if(res.won) {
                        let rev = res.rev * mult;
                        daily_pnl[i] += rev;
                        tradeLog.rev = rev;
                        tradeLog.net = rev - cost;
                        tradeLog.won = true;
                        stats.wins++;
                    } else {
                        if(p.step < 2) {
                            next_active.push({comb: p.comb, step: p.step + 1});
                        } else {
                            stats.losses++;
                        }
                    }
                    dailyTrades.push(tradeLog);
                }
                active_pursuits = next_active;

                // 2. Generate new signals for tomorrow
                let isLastDraw = (i === simData.length - 1);
                let newSignals = [];
                
                if(active_pursuits.length < CONFIG.MAX_CONCURRENT) {
                    let prevBroken = this.getBrokenHeads(simData[i].numbers);
                    let activeCombStrs = active_pursuits.map(p => `${p.comb[0]},${p.comb[1]}`);
                    
                    let candidates = [];
                    for(let comb of CONFIG.COMBS) {
                        if(activeCombStrs.includes(`${comb[0]},${comb[1]}`)) continue;
                        
                        let s = this.calcScore(simData, i, comb, prevBroken);
                        if(s.total >= CONFIG.THRESHOLD) {
                            candidates.push({comb, ...s});
                        }
                    }
                    
                    if(candidates.length > 0) {
                        // Sort: score desc, drought desc
                        candidates.sort((a,b) => {
                            if(b.total !== a.total) return b.total - a.total;
                            return b.dr - a.dr;
                        });
                        
                        // Fill available slots
                        let slots = CONFIG.MAX_CONCURRENT - active_pursuits.length;
                        for(let k=0; k<Math.min(slots, candidates.length); k++) {
                            let best = candidates[k];
                            if(!isLastDraw) {
                                active_pursuits.push({comb: best.comb, step: 0});
                                stats.pursuits++;
                            } else {
                                // Save for prediction
                                newSignals.push(best);
                            }
                        }
                    }
                }

                historyLog.push({
                    date: simData[i].date,
                    nums: simData[i].numbers,
                    trades: dailyTrades
                });

                if(isLastDraw) {
                    AppState.latestPrediction = {
                        active: active_pursuits,
                        newSignals: newSignals
                    };
                }
            }

            // Calc Equity & MDD
            let capital = 0, peak = 0, mdd = 0;
            for(let i=0; i<historyLog.length; i++) {
                let pnl = daily_pnl[20 + i] || 0;
                capital += pnl;
                if(capital > peak) peak = capital;
                let dd = peak - capital;
                if(dd > mdd) mdd = dd;
                historyLog[i].capital = capital;
            }

            return { history: historyLog.reverse(), stats: { capital, mdd, ...stats } };
        }
    };

    // --- 4. UI Module ---
    const UI = {
        status(msg, type) {
            $('statusText').innerText = msg;
            let bar = $('statusProgressBar');
            bar.className = type==='loading' ? 'status-progress-fill indeterminate' : 'status-progress-fill';
            bar.style.width = type==='loading' ? '30%' : '100%';
            if(type!=='loading') setTimeout(()=>bar.style.width='0%', 1000);
        },
        updateInfo() {
            if(AppState.fullData.length) {
                $('dataInfoBlock').innerHTML = `æ•¸æ“šç¯„åœ: ${AppState.fullData[AppState.fullData.length-1].date} ~ ${AppState.fullData[0].date} (å…± ${AppState.fullData.length} æœŸ)`;
            }
        },
        renderStats(res) {
            $('st-profit').innerText = `$${parseInt(res.stats.capital).toLocaleString()}`;
            $('st-profit').className = res.stats.capital > 0 ? "stat-value val-win" : "stat-value val-loss";
            $('st-pursuits').innerText = res.stats.pursuits;
            
            let winRate = res.stats.pursuits ? ((res.stats.wins / res.stats.pursuits) * 100).toFixed(2) : 0;
            $('st-winrate').innerText = `${winRate}%`;
            $('st-mdd').innerText = parseInt(res.stats.mdd).toLocaleString();
        },
        renderPrediction() {
            if(!AppState.latestPrediction || !AppState.fullData.length) return;
            const state = AppState.latestPrediction;
            
            let html = "";
            let slotsUsed = state.active.length;
            
            // 1. Show Currently Active Pursuits
            if(slotsUsed > 0) {
                state.active.forEach(p => {
                    let nextStep = p.step + 1;
                    html += `
                    <div class="priority-card active" style="border-left-color: var(--danger);">
                        <span class="p-rank">ğŸ”¥ è¿½æ“Šä»»å‹™åŸ·è¡Œä¸­ (å³å°‡é€²å…¥ç¬¬ ${nextStep} å±€)</span>
                        ç¹¼çºŒè²·å…¥ <b>${p.comb[0]}/${p.comb[1]}é ­</b>ï¼ŒæŠ•å…¥ <b>${CONFIG.MULTIPLIERS[p.step]} å€</b>æ³¨ç¢¼ã€‚
                    </div>`;
                });
            }

            // 2. Show New Signals
            if(state.newSignals.length > 0) {
                state.newSignals.forEach(sig => {
                    html += `
                    <div class="priority-card active">
                        <span class="p-rank">ğŸ¯ æ»¿åˆ†é€²å ´ï¼š${sig.comb[0]}/${sig.comb[1]}é ­ (ç¸½åˆ†: ${sig.total})</span>
                        <div style="margin-bottom:8px;">åŸºç¤åˆ†: +${sig.base} | æ–·ç‰ŒåŠ æ¬Š: +${sig.bonus} | å‡å€¼èª¿ç¯€: ${sig.trend>0?'+':''}${sig.trend} <small>${sig.trendDesc}</small></div>
                        <b style="color:var(--success);">ç³»çµ±æŒ‡ä»¤ï¼šæ¬¡æœŸå•Ÿå‹• 1-3-8 è¿½æ“Š (ç¸½å‚™é‡‘æº–å‚™ 12,744)</b>
                    </div>`;
                });
            }

            // 3. System Status Badge
            let totalActiveNextDraw = slotsUsed + state.newSignals.length;
            let badgeClass = "badge-wait", badgeTxt = "ç©ºæ‰‹è§€æœ›";
            let mainTxt = "ç„¡é”æ¨™è¨Šè™Ÿ";
            let descTxt = "ç­‰å¾…çµ„åˆé€²å…¥è¶…è³£æˆ–é»ƒé‡‘äº¤å‰é»...";

            if(totalActiveNextDraw > 0) {
                badgeClass = totalActiveNextDraw === CONFIG.MAX_CONCURRENT ? "badge-lock" : "badge-pursuit";
                badgeTxt = totalActiveNextDraw === CONFIG.MAX_CONCURRENT ? "ç³»çµ±æ»¿è¼‰ (é–å€‰ä¸­)" : "è¨Šè™Ÿè§¸ç™¼";
                mainTxt = "æº–å‚™ä¸‹æ³¨";
                descTxt = `ç›®å‰ä½”ç”¨ ${totalActiveNextDraw}/${CONFIG.MAX_CONCURRENT} å€‹åŸ·è¡Œç·’ã€‚è«‹ä¾æ“šä¸‹æ–¹æŒ‡ä»¤è¡Œå‹•ã€‚`;
            }

            $('pred-badge').className = `sig-badge ${badgeClass}`;
            $('pred-badge').innerText = badgeTxt;
            $('pred-strategy').innerText = mainTxt;
            $('pred-desc').innerHTML = descTxt;
            $('signalContainer').innerHTML = html;

            $('last-bet-date').innerText = AppState.fullData[0].date;
            let d = new Date(AppState.fullData[0].date);
            d.setDate(d.getDate() + 1); if(d.getDay()===0) d.setDate(d.getDate()+1);
            $('nextDrawDate').innerText = `${d.getMonth()+1}/${d.getDate()} (é€±${"æ—¥ä¸€äºŒä¸‰å››äº”å…­"[d.getDay()]})`;
        },
        renderTable() {
            const t = $('fullHistoryBody'); t.innerHTML = '';
            // Filter to only show days where trades happened
            const tradedHistory = AppState.history.filter(x => x.trades && x.trades.length > 0);
            const start = (AppState.page-1)*15, end = Math.min(start+15, tradedHistory.length);
            $('pageInfo').innerText = `ç¬¬ ${AppState.page} é  / å…± ${Math.ceil(tradedHistory.length/15) || 1} é `;

            for(let i=start; i<end; i++) {
                let row = tradedHistory[i];
                let balls = row.nums.map(n => `<span class="num-ball">${n<10?'0'+n:n}</span>`).join('');
                
                let tradeHtmls = row.trades.map(tr => {
                    let sigTxt = `<span style="color:#cbd5e1">3D é”æ¨™é€²å ´</span>`;
                    let stratTxt = `${tr.combStr}é ­ <small style="color:${tr.step>=2?'#fca5a5':'#64748b'}">(ç¬¬${tr.step+1}å±€ x${tr.mult})</small>`;
                    let resTxt = `<span class="res-badge ${tr.won?'badge-win':'badge-loss'}">${tr.won?'åœåˆ©äº†çµ':'æœªä¸­ / çºŒè¿½'}</span>`;
                    if(!tr.won && tr.step === 2) resTxt = `<span class="res-badge badge-loss" style="background:#ef4444; color:white;">æ–·é ­åœæ</span>`;
                    
                    return `
                        <tr>
                            <td style="color:#94a3b8">${row.date.slice(5)}</td>
                            <td>${balls}</td>
                            <td>${sigTxt}</td>
                            <td>${stratTxt}</td>
                            <td style="font-weight:bold; color:${tr.net>0?'#34d399':'#f87171'}">${tr.net>0?'+':''}${parseInt(tr.net)}</td>
                            <td>${resTxt}</td>
                        </tr>
                    `;
                }).join('');
                t.innerHTML += tradeHtmls;
            }
        },
        renderChart() {
            if(AppState.chart) AppState.chart.destroy();
            let data = AppState.history.slice().reverse().map(d => d.capital);
            let labels = AppState.history.slice().reverse().map(d => d.date);

            const ctx = $('equityChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0,0,0,300);
            gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)'); gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');

            AppState.chart = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels, 
                    datasets: [{ 
                        label:'ç´¯ç©æ·¨åˆ©', data, 
                        borderColor: '#818cf8', backgroundColor: gradient, 
                        fill: true, borderWidth:2, pointRadius:0, tension:0.1 
                    }] 
                },
                options: { 
                    responsive:true, maintainAspectRatio:false, 
                    plugins:{ legend:{display:false} }, 
                    scales:{ 
                        x:{grid:{display:false}, ticks:{callback:v=>labels[v].slice(0,4), maxTicksLimit:8}}, 
                        y:{grid:{color:'rgba(255,255,255,0.05)'}} 
                    } 
                }
            });
        },
        changePage(d) {
            let tradedHistory = AppState.history.filter(x => x.trades && x.trades.length > 0);
            let max = Math.ceil(tradedHistory.length/15);
            AppState.page = Math.min(Math.max(1, AppState.page+d), max);
            this.renderTable();
        }
    };

    // --- 5. Main Controller ---
    const App = {
        init() { Data.init(); },
        runEngine() {
            let result = Engine.run();
            if(!result) return;
            AppState.history = result.history;
            AppState.page = 1;
            
            UI.renderStats(result);
            UI.renderPrediction();
            UI.renderTable();
            UI.renderChart();
        },
        runAnalysis() { this.runEngine(); },
        resetData() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¿«å–è³‡æ–™ä¸¦é‡æ–°ä¸‹è¼‰å—ï¼Ÿ")) {
                localStorage.removeItem(CONFIG.STORAGE_KEY);
                AppState.fullData = [];
                Data.init();
            }
        },
        manualInput() {
            let nums = [1,2,3,4,5].map(i => parseInt($(`m${i}`).value));
            if(nums.some(isNaN)) return alert("è«‹è¼¸å…¥å®Œæ•´5å€‹è™Ÿç¢¼");
            let today = new Date().toISOString().split('T')[0].replace(/-/g,'/');
            AppState.fullData.unshift({date: today, numbers: nums});
            Data.merge([]); 
            $('manualInputSection').style.display='none';
            this.runEngine();
        }
    };

    window.onload = () => App.init();
</script>
</body>
</html>
